{% assign related_count = 0 %}
<div class="related-posts" style="margin-top: 2rem;">

  {% for post in site.posts %}
    {% assign shared_tag = false %}

    {% for tag in post.tags %}
      {% if page.tags contains tag and post.url != page.url %}
        {% assign shared_tag = true %}
      {% endif %}
    {% endfor %}

    {% if shared_tag %}
      {% if related_count == 0 %}
        <h4>Related Posts</h4>
        <ul>
      {% endif %}

      <li class="relatedPost">
        <a href="{{ site.url }}{{ post.url }}">
          {{ post.title }}
          {% if post.series %}
            <span class="series">(Series: {{ post.series }})</span>
          {% endif %}
        </a>
      </li>

      {% assign related_count = related_count | plus: 1 %}
      {% if related_count == 5 %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if related_count > 0 %}
    </ul>
  {% else %}
    <p>No related posts found.</p>
  {% endif %}

</div>
